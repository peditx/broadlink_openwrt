<%+header%>

<div class="cbi-map">
    <h2><%:Learn IR/RF Codes%></h2>
    
    <div class="cbi-section">
        <% if devices and #devices > 0 then %>
            <div class="cbi-value">
                <label class="cbi-value-title"><%:Select Device:%></label>
                <div class="cbi-value-field">
                    <select id="device-select">
                        <% for _, dev in ipairs(devices) do %>
                            <option value="<%=dev.mac%>"><%=dev.name%> (<%=dev.mac%>)</option>
                        <% end %>
                    </select>
                </div>
            </div>
            
            <div class="cbi-value">
                <label class="cbi-value-title"><%:Code Type:%></label>
                <div class="cbi-value-field">
                    <select id="code-type">
                        <option value="ir">IR</option>
                        <option value="rf">RF</option>
                    </select>
                </div>
            </div>
            
            <button class="cbi-button cbi-button-apply" onclick="startLearning()"><%:Start Learning%></button>
            
            <div id="learning-status" class="alert-message" style="display:none; margin-top:15px">
                <div class="spinner"></div>
                <span><%:Learning in progress...%></span>
            </div>
            
            <div id="learned-code" class="alert-message success" style="display:none; margin-top:15px"></div>
        <% else %>
            <div class="alert-message warning">
                <%:No devices found! Please add devices first.%>
            </div>
        <% end %>
    </div>
</div>

<script>
function startLearning() {
    const deviceMac = document.getElementById('device-select').value;
    const codeType = document.getElementById('code-type').value;
    
    document.getElementById('learning-status').style.display = 'block';
    
    fetch('/cgi-bin/luci/admin/services/broadlink/learn_action?mac=' + encodeURIComponent(deviceMac) + '&type=' + codeType)
        .then(response => {
            if (!response.ok) throw new Error('HTTP ' + response.status);
            return response.json();
        })
        .then(data => {
            document.getElementById('learning-status').style.display = 'none';
            if(data.success) {
                document.getElementById('learned-code').innerHTML = 
                    '<%:Learned Code:%> <code>' + data.code + '</code>';
                document.getElementById('learned-code').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('<%:Learning failed!%>');
        });
}
</script>

<%+footer%>
